rule: LT01

test_fail_no_space_after_using_clause:
  fail_str: select * from a JOIN b USING(x)
  fix_str: select * from a JOIN b USING (x)

test_pass_newline_after_using_clause:
  # Check LT01 passes if there's a newline between
  pass_str: |
    select * from a JOIN b USING
    (x)

test_fail_cte_no_space_after_as:
  # Check fixing of single space rule when space is missing
  fail_str: WITH a AS(select 1) select * from a
  fix_str: WITH a AS (select 1) select * from a

test_fail_multiple_spaces_after_as:
  # Check fixing of single space rule on multiple spaces
  fail_str: WITH a AS  (select 1) select * from a
  fix_str: WITH a AS (select 1) select * from a

test_fail_cte_newline_after_as:
  # Check fixing of replacing newline with space
  fail_str: |
    WITH a AS
    (
      select 1
    )
    select * from a
  fix_str: |
    WITH a AS (
      select 1
    )
    select * from a

test_fail_cte_newline_and_spaces_after_as:
  # Check stripping newlines and extra whitespace
  fail_str: |
    WITH a AS


        (
      select 1
    )
    select * from a
  fix_str: |
    WITH a AS (
      select 1
    )
    select * from a

test_pass_cte_comment_after_as:
  # https://github.com/sqlfluff/sqlfluff/issues/6125
  # When handling the 'single:inline' constraint,
  # prohibit stripping newlines after comment segments.
  pass_str: |
    WITH
    a AS -- comment
    (
    select 1
    )
    select * from a

test_fail_postgres_cycle_clause_with_blank_line:
  # PostgreSQL CYCLE clause should be on same line as closing bracket
  # LT01 should remove blank lines and add single space between ) and CYCLE
  fail_str: |
    WITH RECURSIVE t (n) AS (
        VALUES (1)
        UNION ALL
        SELECT n + 1 FROM t
        WHERE n < 10
    )

    CYCLE n SET is_cycle USING path
    SELECT * FROM t;
  fix_str: |
    WITH RECURSIVE t (n) AS (
        VALUES (1)
        UNION ALL
        SELECT n + 1 FROM t
        WHERE n < 10
    ) CYCLE n SET is_cycle USING path
    SELECT * FROM t;
  configs:
    core:
      dialect: postgres

test_pass_postgres_cycle_clause:
  # PostgreSQL CYCLE clause correctly formatted
  pass_str: |
    WITH RECURSIVE t (n) AS (
        VALUES (1)
        UNION ALL
        SELECT n + 1 FROM t
        WHERE n < 10
    ) CYCLE n SET is_cycle USING path
    SELECT * FROM t;
  configs:
    core:
      dialect: postgres

test_pass_postgres_search_clause:
  # PostgreSQL SEARCH clause correctly formatted
  pass_str: |
    WITH RECURSIVE t (id, link) AS (
        SELECT id, link FROM tree
        UNION ALL
        SELECT t.id, t.link FROM tree t, t st WHERE t.id = st.link
    ) SEARCH DEPTH FIRST BY id SET ordercol
    SELECT * FROM t;
  configs:
    core:
      dialect: postgres
